import dash
from dash import dcc, html
from dash.dependencies import Input, Output
import pandas as pd
import plotly.express as px


def load_data():
    try:

        df = pd.read_csv('btc_prices.csv', names=['timestamp', 'price'], header=None)
        df['timestamp'] = pd.to_datetime(df['timestamp'])
        df['price'] = pd.to_numeric(df['price'])
        return df
    except Exception as e:
        print("Erreur lors du chargement du CSV :", e)
        return pd.DataFrame(columns=['timestamp', 'price'])


app = dash.Dash(__name__)
app.title = "Dashboard - Prix du Bitcoin"

app.layout = html.Div([
    html.H1("Dashboard - Prix du Bitcoin"),
    dcc.Graph(id='price-graph'),
    html.Div(id='latest-price', style={'fontSize': 24, 'marginTop': '20px'}),
    # composant Interval pour mettre à jour le dashboard toutes les 5 minutes
    dcc.Interval(
        id='interval-component',
        interval=5*60*1000,  # 5 minutes en millisecondes
        n_intervals=0
    )
])

# Callback pour actualiser le graphique et le dernier prix
@app.callback(
    [Output('price-graph', 'figure'),
     Output('latest-price', 'children')],
    [Input('interval-component', 'n_intervals')]
)
def update_dashboard(n):
    df = load_data()
    if df.empty:
        return {}, "Aucune donnée disponible pour le moment."
    
    # graphique
    fig = px.line(df, x='timestamp', y='price', title='Evolution du Prix du Bitcoin',
                  labels={'timestamp': 'Date et Heure', 'price': 'Prix (USD)'})
    
    # dernière mesure
    latest = df.iloc[-1]
    latest_text = f"Dernière mesure ({latest['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}) : {latest['price']} USD"
    
    return fig, latest_text

if __name__ == '__main__':
    app.run_server(debug=True)
